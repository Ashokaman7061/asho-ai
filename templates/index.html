<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asho AI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
  <style>
    :root {
      --bg: #1f1f1f;
      --panel: #171717;
      --panel-2: #212121;
      --hover: #2b2b2b;
      --border: #2f2f2f;
      --text: #ececec;
      --muted: #a3a3a3;
      --accent: #8ab4ff;
      --user-bubble: #2d2d2d;
      --inline-code-bg: #303030;
      --inline-code-border: #3a3a3a;
      --code-bg: #121212;
      --code-text: #e7e7e7;
      --input-bar-bg: rgba(31,31,31,.95);
      --send-fg: #161616;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 72px;
      --content-w: 768px;
      --header-h: 56px;
      --input-h-gap: 136px;
    }

    body[data-theme="light"] {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --panel-2: #f3f5f7;
      --hover: #e8edf2;
      --border: #d7dde5;
      --text: #18202a;
      --muted: #5a6a7b;
      --accent: #3666d6;
      --user-bubble: #e9eef5;
      --inline-code-bg: #eef2f7;
      --inline-code-border: #d8e0ea;
      --code-bg: #f7f9fb;
      --code-text: #1a2430;
      --input-bar-bg: rgba(244,246,248,.95);
      --send-fg: #ffffff;
    }

    * { box-sizing: border-box; }

    html, body { width: 100%; height: 100%; margin: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }

    .layout {
      height: 100vh;
      display: flex;
      position: relative;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(1px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 20;
    }

    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar {
      width: var(--sidebar-w);
      height: 100%;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width .2s ease, transform .2s ease;
      z-index: 30;
      flex: 0 0 auto;
      overflow: hidden;
    }

    .sidebar.closed {
      width: 0;
      border-right: 0;
    }

    .side-top { padding: 12px; display: flex; gap: 8px; }

    .icon-btn, .new-chat-btn, .chat-item, .bottom-btn {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 12px;
      transition: all .2s ease;
    }

    .icon-btn:hover, .new-chat-btn:hover, .bottom-btn:hover { background: var(--hover); }

    .new-chat-btn {
      height: 40px;
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .icon-btn {
      width: 46px;
      height: 46px;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .side-collapse {
      background: transparent;
      border: 0;
      border-radius: 10px;
      box-shadow: none;
      padding: 0;
    }

    .side-collapse:hover {
      background: color-mix(in srgb, var(--hover) 72%, transparent);
      transform: none;
    }

    .toggle-logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      display: block;
    }
    .search-wrap { padding: 0 12px 10px; }

    .search {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }

    .search::placeholder { color: var(--muted); }

    .history {
      flex: 1;
      overflow: auto;
      padding: 0 8px 10px;
    }

    .chat-item {
      border: 0;
      width: 100%;
      text-align: left;
      padding: 10px 10px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      cursor: pointer;
      position: relative;
      color: var(--muted);
    }

    .chat-item:hover, .chat-item.active {
      background: var(--hover);
      color: var(--text);
    }

    .chat-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      font-size: 14px;
    }

    .delete-chat {
      border: 0;
      background: transparent;
      color: var(--muted);
      opacity: 0;
      cursor: pointer;
      transition: opacity .2s ease, color .2s ease;
    }

    .chat-item:hover .delete-chat { opacity: 1; }
    .delete-chat:hover { color: var(--text); }

    .side-bottom {
      padding: 10px 12px 12px;
      border-top: 1px solid var(--border);
    }

    .bottom-btn {
      width: 100%;
      border: 0;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      color: var(--muted);
      cursor: pointer;
    }

    .profile-dot {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #3a3a3a;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg);
      position: relative;
    }

    .header {
      height: var(--header-h);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      flex: 0 0 auto;
      background: var(--bg);
      z-index: 5;
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mobile-toggle {
      display: none;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .mobile-toggle:hover { background: var(--hover); color: var(--text); }

    .desktop-closed-toggle { display: none; }

    .sidebar.closed + .main .desktop-closed-toggle {
      display: grid;
      place-items: center;
    }

    .model-select {
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      color: var(--text);
      padding: 0 34px 0 10px;
      font-size: 13px;
      outline: none;
    }

    .chat-title {
      display: none;
    }

    .header-action {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .header-action:hover { background: var(--hover); color: var(--text); }

    .messages-wrap {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0 var(--input-h-gap);
      scrollbar-width: thin;
      scrollbar-color: #434343 transparent;
    }

    .welcome-panel {
      width: 100%;
      max-width: var(--content-w);
      margin: 120px auto 26px;
      padding: 0 16px;
      text-align: center;
    }

    .welcome-panel.hidden { display: none; }

    .welcome-mark {
      width: min(480px, 78vw);
      height: auto;
      margin: 0 auto;
      display: block;
      object-fit: contain;
    }

    .message-row {
      display: flex;
      width: 100%;
      max-width: var(--content-w);
      margin: 0 auto 24px;
      padding: 0 16px;
      animation: fadeUp .2s ease;
    }

    .message-row.user { justify-content: flex-end; }
    .message-row.assistant { justify-content: flex-start; }

    .message {
      max-width: 85%;
      font-size: 15px;
      line-height: 1.65;
      position: relative;
    }

    .message.user {
      background: var(--user-bubble);
      border-radius: 22px;
      padding: 11px 14px;
      white-space: pre-wrap;
    }

    .message.assistant { width: 100%; }

    .message.assistant p { margin: 0 0 10px; }
    .message.assistant ul, .message.assistant ol { margin: 0 0 10px; padding-left: 22px; }
    .message.assistant li { margin: 2px 0; }
    .message.assistant h1, .message.assistant h2, .message.assistant h3 {
      margin: 14px 0 8px;
      line-height: 1.3;
    }

    .message.assistant h1 { font-size: 1.22rem; }
    .message.assistant h2 { font-size: 1.12rem; }
    .message.assistant h3 { font-size: 1.02rem; }

    .message.assistant :not(pre) > code {
      background: var(--inline-code-bg);
      border: 1px solid var(--inline-code-border);
      border-radius: 6px;
      padding: 2px 6px;
      font-family: Consolas, "Courier New", monospace;
      font-size: .92em;
    }

    .code-wrap { position: relative; margin: 10px 0 6px; }

    .message.assistant pre {
      margin: 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--code-bg);
      padding: 14px;
      overflow-x: auto;
    }

    .message.assistant pre code {
      font-family: Consolas, "Courier New", monospace;
      font-size: .9em;
      line-height: 1.6;
      color: var(--code-text);
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel);
      color: var(--muted);
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity .2s ease, color .2s ease;
    }

    .code-wrap:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { color: var(--text); }

    .typing {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--panel-2);
    }

    .typing span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--muted);
      animation: dot 1.1s infinite ease-in-out;
    }

    .typing span:nth-child(2) { animation-delay: .12s; }
    .typing span:nth-child(3) { animation-delay: .24s; }

    .input-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid var(--border);
      background: var(--input-bar-bg);
      backdrop-filter: blur(5px);
      padding: 10px 16px 16px;
      box-shadow: 0 -10px 24px rgba(0,0,0,.22);
    }

    .input-inner {
      width: 100%;
      max-width: var(--content-w);
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      border-radius: 24px;
      padding: 10px 12px;
      transition: border-color .2s ease;
    }

    .input-inner:focus-within { border-color: #4e73a6; }

    #q {
      flex: 1;
      resize: none;
      min-height: 24px;
      max-height: 200px;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font: inherit;
      line-height: 1.5;
    }

    #q::placeholder { color: var(--muted); }

    #sendBtn {
      width: 36px;
      height: 36px;
      border: 0;
      border-radius: 50%;
      background: var(--text);
      color: var(--send-fg);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all .2s ease;
      flex: 0 0 auto;
    }

    #sendBtn:hover { box-shadow: 0 0 16px rgba(255,255,255,.2); }
    #sendBtn.is-stop {
      background: #df3e3e;
      color: #fff;
    }

    .hidden-when-collapsed { display: inline; }
    .sidebar.closed .hidden-when-collapsed { display: none; }

    @keyframes dot {
      0%, 80%, 100% { transform: translateY(0); opacity: .45; }
      40% { transform: translateY(-4px); opacity: 1; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        width: var(--sidebar-w) !important;
      }

      .sidebar.closed {
        width: var(--sidebar-w) !important;
        border-right: 1px solid var(--border);
      }

      .sidebar.open { transform: translateX(0); }
      .mobile-toggle { display: grid; place-items: center; }
      .desktop-closed-toggle { display: none !important; }
      .side-collapse { display: none; }
      .message { max-width: 92%; }
      .input-bar { padding-left: 12px; padding-right: 12px; }
      .welcome-panel {
        margin-top: 92px;
      }
      .chat-title {
      display: none;
    }
    }
  </style>
</head>
<body>
  <div id="overlay" class="overlay"></div>
  <div class="layout">
    <aside id="sidebar" class="sidebar closed">
      <div class="side-top">
        <button id="newChat" class="new-chat-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14" stroke-linecap="round"/></svg>
          <span class="hidden-when-collapsed">New chat</span>
        </button>
        <button id="collapseBtn" class="icon-btn side-collapse" type="button" aria-label="Toggle sidebar">
          <img class="toggle-logo" src="{{ url_for('static', filename='sidebar logo.png') }}" alt="Toggle sidebar" />
        </button>
      </div>

      <div class="search-wrap hidden-when-collapsed">
        <input id="search" class="search" placeholder="Search chats" />
      </div>

      <div class="history" id="history"></div>

      <div class="side-bottom">
        <button class="bottom-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M4.93 4.93l2.12 2.12M16.95 16.95l2.12 2.12M2 12h3M19 12h3M4.93 19.07l2.12-2.12M16.95 7.05l2.12-2.12" stroke-linecap="round"/></svg>
          <span class="hidden-when-collapsed">Settings</span>
        </button>
        <button class="bottom-btn" type="button">
          <span class="profile-dot">A</span>
          <span class="hidden-when-collapsed">Ashok Aman</span>
        </button>
      </div>
    </aside>

    <main class="main">
      <header class="header">
        <div class="header-left">
          <button id="desktopClosedToggle" class="icon-btn side-collapse desktop-closed-toggle" type="button" aria-label="Open sidebar">
            <img class="toggle-logo" src="{{ url_for('static', filename='sidebar logo.png') }}" alt="Open sidebar" />
          </button>
          <button id="mobileToggle" class="mobile-toggle" type="button" aria-label="Open sidebar">
            <img class="toggle-logo" src="{{ url_for('static', filename='sidebar logo.png') }}" alt="Open sidebar" />
          </button>
          
        </div>

        <div class="chat-title" id="chatTitle">Asho AI</div>

        <div class="header-right">
          <button id="themeToggle" class="header-action" type="button" aria-label="Toggle theme">
            <svg id="themeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
          </button>
        </div>
      </header>

      <section id="chat" class="messages-wrap">
        <div id="welcomePanel" class="welcome-panel">
          <img class="welcome-mark" src="{{ url_for('static', filename='Ai logo.png') }}" alt="Asho AI logo" />
        </div>
      </section>

      <div class="input-bar">
        <form id="f" class="input-inner">
          <textarea id="q" rows="1" placeholder="Ask anything"></textarea>
          <button type="submit" id="sendBtn" aria-label="Send">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h13" stroke-linecap="round" />
              <path d="m12 5 7 7-7 7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const collapseBtn = document.getElementById("collapseBtn");
    const desktopClosedToggle = document.getElementById("desktopClosedToggle");
    const mobileToggle = document.getElementById("mobileToggle");
    const searchInput = document.getElementById("search");
    const historyEl = document.getElementById("history");
    const chatTitle = document.getElementById("chatTitle");
    const newChatBtn = document.getElementById("newChat");
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    const chat = document.getElementById("chat");
    const welcomePanel = document.getElementById("welcomePanel");
    const form = document.getElementById("f");
    const input = document.getElementById("q");
    const sendBtn = document.getElementById("sendBtn");
    const sendIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h13" stroke-linecap="round"></path><path d="m12 5 7 7-7 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>';
    const stopIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="7" y="7" width="10" height="10" rx="2"></rect></svg>';

    let controller;
    let isStreaming = false;
    let chats = [];
    let activeChatId = null;

    function isMobile() {
      return window.matchMedia("(max-width: 900px)").matches;
    }

    async function apiJson(url, options = {}) {
      const res = await fetch(url, options);
      let payload = {};
      try {
        payload = await res.json();
      } catch {}
      if (!res.ok) {
        throw new Error(payload.error || "Request failed.");
      }
      return payload;
    }

    function updateChatMeta(id, title) {
      const idx = chats.findIndex(c => c.id === id);
      if (idx === -1) return;
      chats[idx].title = title || chats[idx].title;
      const updated = chats.splice(idx, 1)[0];
      chats.unshift(updated);
    }

    function renderHistory() {
      const q = (searchInput.value || "").toLowerCase();
      const filtered = chats.filter(c => (c.title || "").toLowerCase().includes(q));
      historyEl.innerHTML = "";

      for (const c of filtered) {
        const row = document.createElement("button");
        row.type = "button";
        row.className = "chat-item" + (c.id === activeChatId ? " active" : "");
        row.innerHTML = `
          <span class="chat-label">${escapeHtml(c.title || "New chat")}</span>
          <span class="delete-chat" aria-label="Delete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18" stroke-linecap="round"/><path d="M8 6V4h8v2" stroke-linecap="round"/><path d="m19 6-1 14H6L5 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
        `;

        row.addEventListener("click", async (e) => {
          const del = e.target.closest(".delete-chat");
          if (del) {
            e.stopPropagation();
            await deleteConversation(c.id);
            return;
          }
          await selectConversation(c.id);
          if (isMobile()) closeMobileSidebar();
        });

        historyEl.appendChild(row);
      }
    }

    function setDesktopSidebarClosed(closed) {
      sidebar.classList.toggle("closed", closed);
      collapseBtn.setAttribute("aria-label", closed ? "Open sidebar" : "Close sidebar");
    }

    function toggleDesktopSidebar() {
      setDesktopSidebarClosed(!sidebar.classList.contains("closed"));
    }

    function openMobileSidebar() {
      sidebar.classList.add("open");
      overlay.classList.add("open");
    }

    function closeMobileSidebar() {
      sidebar.classList.remove("open");
      overlay.classList.remove("open");
    }

    function autoResize() {
      input.style.height = "0px";
      input.style.height = Math.min(input.scrollHeight, 200) + "px";
    }

    function scrollToBottom() {}

    function clearMessages() {
      chat.querySelectorAll(".message-row").forEach((row) => row.remove());
      removeTyping();
    }

    function setWelcomeVisible(isVisible) {
      welcomePanel.classList.toggle("hidden", !isVisible);
    }

    function refreshWelcome() {
      const hasMessage = !!chat.querySelector(".message-row");
      setWelcomeVisible(!hasMessage);
    }

    function addMessageRow(kind, htmlText) {
      setWelcomeVisible(false);
      const row = document.createElement("div");
      row.className = "message-row " + kind;
      const msg = document.createElement("article");
      msg.className = "message " + kind;
      if (kind === "assistant") {
        msg.innerHTML = htmlText;
      } else {
        msg.textContent = htmlText;
      }
      row.appendChild(msg);
      chat.appendChild(row);
      return msg;
    }

    function renderConversationMessages(messages) {
      clearMessages();
      for (const m of messages || []) {
        if (m.role === "assistant") {
          const node = addMessageRow("assistant", renderSafeMarkdown(m.content || ""));
          addCopyButtons(node);
        } else if (m.role === "user") {
          addMessageRow("user", m.content || "");
        }
      }
      refreshWelcome();
    }

    function addTyping() {
      setWelcomeVisible(false);
      const row = document.createElement("div");
      row.className = "message-row assistant";
      row.id = "typingRow";
      row.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
      chat.appendChild(row);
    }

    function removeTyping() {
      const t = document.getElementById("typingRow");
      if (t) t.remove();
    }

    function addCopyButtons(container) {
      const blocks = container.querySelectorAll("pre > code");
      for (const code of blocks) {
        const pre = code.parentElement;
        if (!pre || pre.parentElement?.classList.contains("code-wrap")) continue;

        const wrap = document.createElement("div");
        wrap.className = "code-wrap";
        pre.parentNode.insertBefore(wrap, pre);
        wrap.appendChild(pre);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "copy-btn";
        btn.textContent = "Copy";
        btn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(code.textContent || "");
            btn.textContent = "Copied";
            setTimeout(() => btn.textContent = "Copy", 1200);
          } catch {
            btn.textContent = "Failed";
            setTimeout(() => btn.textContent = "Copy", 1200);
          }
        });
        wrap.appendChild(btn);
      }
    }

    function setStreaming(streaming) {
      isStreaming = streaming;
      input.disabled = streaming;
      sendBtn.classList.toggle("is-stop", streaming);
      sendBtn.setAttribute("aria-label", streaming ? "Stop" : "Send");
      sendBtn.innerHTML = streaming ? stopIcon : sendIcon;
    }

    function applyTheme(theme) {
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      if (theme === "light") {
        themeIcon.innerHTML = '<path d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8Z" stroke-linecap="round" stroke-linejoin="round"></path>';
      } else {
        themeIcon.innerHTML = '<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke-linecap="round"></path>';
      }
    }

    function initTheme() {
      const stored = localStorage.getItem("theme");
      if (stored === "light" || stored === "dark") {
        applyTheme(stored);
        return;
      }
      const prefersLight = window.matchMedia("(prefers-color-scheme: light)").matches;
      applyTheme(prefersLight ? "light" : "dark");
    }

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderSafeMarkdown(text) {
      const rawHtml = marked.parse(text || "");
      return DOMPurify.sanitize(rawHtml);
    }

    async function selectConversation(conversationId) {
      const data = await apiJson(`/conversations/${conversationId}`);
      const c = data.conversation;
      activeChatId = c.id;
      chatTitle.textContent = c.title || "New chat";
      renderConversationMessages(c.messages || []);
      renderHistory();
    }

    async function deleteConversation(conversationId) {
      await apiJson(`/conversations/${conversationId}`, { method: "DELETE" });
      chats = chats.filter(c => c.id !== conversationId);
      if (activeChatId === conversationId) {
        if (chats.length) {
          await selectConversation(chats[0].id);
        } else {
          activeChatId = null;
          chatTitle.textContent = "Asho AI";
          clearMessages();
          refreshWelcome();
          renderHistory();
        }
      } else {
        renderHistory();
      }
    }

    async function loadConversations(preferredId = null, opts = {}) {
      const autoSelectExisting = opts.autoSelectExisting ?? true;
      const data = await apiJson("/conversations");
      chats = data.conversations || [];
      renderHistory();
      if (chats.length) {
        if (preferredId && chats.some(c => c.id === preferredId)) {
          await selectConversation(preferredId);
          return;
        }
        if (autoSelectExisting && activeChatId && chats.some(c => c.id === activeChatId)) {
          await selectConversation(activeChatId);
          return;
        }
        if (!autoSelectExisting) {
          activeChatId = null;
          chatTitle.textContent = "New chat";
          clearMessages();
          refreshWelcome();
          renderHistory();
        }
      } else {
        activeChatId = null;
        chatTitle.textContent = "Asho AI";
        clearMessages();
        refreshWelcome();
      }
    }

    collapseBtn.addEventListener("click", toggleDesktopSidebar);
    desktopClosedToggle.addEventListener("click", toggleDesktopSidebar);
    mobileToggle.addEventListener("click", () => {
      if (isMobile()) {
        openMobileSidebar();
      } else {
        toggleDesktopSidebar();
      }
    });
    overlay.addEventListener("click", closeMobileSidebar);
    searchInput.addEventListener("input", renderHistory);

    newChatBtn.addEventListener("click", () => {
      activeChatId = null;
      chatTitle.textContent = "New chat";
      clearMessages();
      refreshWelcome();
      renderHistory();
      if (isMobile()) closeMobileSidebar();
    });

    input.addEventListener("input", autoResize);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    themeToggle.addEventListener("click", () => {
      const current = document.body.getAttribute("data-theme") === "light" ? "light" : "dark";
      applyTheme(current === "light" ? "dark" : "light");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (isStreaming) {
        if (controller) controller.abort();
        return;
      }

      const text = input.value.trim();
      if (!text) return;

      setStreaming(true);
      input.value = "";
      autoResize();
      addMessageRow("user", text);

      removeTyping();
      addTyping();

      controller = new AbortController();

      try {
        const payload = { message: text };
        if (activeChatId) payload.conversation_id = activeChatId;

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });

        if (!res.ok || !res.body) {
          removeTyping();
          addMessageRow("assistant", "Request failed.");
          return;
        }

        const responseConversationId = res.headers.get("X-Conversation-Id");
        if (responseConversationId) {
          activeChatId = responseConversationId;
        }

        const titleFromHeader = res.headers.get("X-Conversation-Title");
        if (titleFromHeader) {
          chatTitle.textContent = titleFromHeader;
          updateChatMeta(activeChatId, titleFromHeader);
          renderHistory();
        }

        removeTyping();
        const botDiv = addMessageRow("assistant", "");

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let botText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          botText += decoder.decode(value, { stream: true });
          botDiv.innerHTML = renderSafeMarkdown(botText);
          addCopyButtons(botDiv);
        }

        await loadConversations(activeChatId);
      } catch (err) {
        removeTyping();
        if (err.name === "AbortError") {
          addMessageRow("assistant", "Stopped.");
        } else {
          addMessageRow("assistant", "Request failed.");
        }
      } finally {
        controller = undefined;
        setStreaming(false);
        input.focus();
      }
    });

    window.addEventListener("resize", () => {
      if (isMobile()) {
        sidebar.classList.remove("closed");
      } else {
        closeMobileSidebar();
      }
    });

    if (isMobile()) {
      sidebar.classList.remove("closed");
    } else {
      setDesktopSidebarClosed(true);
    }

    initTheme();
    autoResize();
    loadConversations(null, { autoSelectExisting: false }).catch(() => {
      chatTitle.textContent = "Asho AI";
      clearMessages();
      refreshWelcome();
    });
  </script>
</body>
</html>
















