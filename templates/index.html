<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asho AI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
  {% if auth_enabled and google_client_id %}
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  {% endif %}
  <style>
    :root {
      --bg: #1f1f1f;
      --panel: #171717;
      --panel-2: #212121;
      --hover: #2b2b2b;
      --border: #2f2f2f;
      --text: #ececec;
      --muted: #a3a3a3;
      --accent: #8ab4ff;
      --user-bubble: #2d2d2d;
      --inline-code-bg: #303030;
      --inline-code-border: #3a3a3a;
      --code-bg: #121212;
      --code-text: #e7e7e7;
      --input-bar-bg: rgba(31,31,31,.95);
      --send-fg: #161616;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 72px;
      --content-w: 768px;
      --header-h: 56px;
      --input-h-gap: 136px;
    }

    body[data-theme="light"] {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --panel-2: #f3f5f7;
      --hover: #e8edf2;
      --border: #d7dde5;
      --text: #18202a;
      --muted: #5a6a7b;
      --accent: #3666d6;
      --user-bubble: #e9eef5;
      --inline-code-bg: #eef2f7;
      --inline-code-border: #d8e0ea;
      --code-bg: #f7f9fb;
      --code-text: #1a2430;
      --input-bar-bg: rgba(244,246,248,.95);
      --send-fg: #ffffff;
    }

    * { box-sizing: border-box; }

    html, body { width: 100%; height: 100%; margin: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }

    .layout {
      height: 100vh;
      display: flex;
      position: relative;
    }
    .login-gate {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: color-mix(in srgb, var(--bg) 82%, #000 18%);
      z-index: 60;
      padding: 16px;
    }
    .layout.auth-locked .login-gate { display: grid; }
    .layout.auth-locked .sidebar,
    .layout.auth-locked .main {
      filter: blur(2px);
      pointer-events: none;
      user-select: none;
    }
    .login-card {
      width: min(520px, 92vw);
      border: 1px solid var(--border);
      background: #12141c;
      border-radius: 22px;
      padding: 26px 22px;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
      text-align: left;
    }
    .login-brand { display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .logo-full { width: min(260px, 70vw); height: auto; display: block; }
    .logo-icon { width: 40px; height: 40px; display: block; }
    .login-title { font-size: 1.1rem; margin: 0 0 6px; text-align: center; }
    .login-sub { margin: 0 0 16px; color: #9ea8be; font-size: 14px; text-align: center; }
    .login-form { display: grid; gap: 10px; }
    .password-wrap { position: relative; }
    .login-input {
      width: 100%;
      border: 1px solid #2b3040;
      border-radius: 999px;
      background: #171b26;
      color: #e8ecf8;
      padding: 12px 14px;
      font-size: 15px;
      outline: none;
    }
    .login-input:focus { border-color: #4f79ff; box-shadow: 0 0 0 3px rgba(79,121,255,.16); }
    .password-wrap .login-input { padding-right: 48px; }
    .pass-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent;
      color: #9ea8be;
      cursor: pointer;
      font-size: 12px;
      padding: 6px;
    }
    .login-primary {
      border: 0;
      border-radius: 999px;
      background: linear-gradient(180deg, #5d89ff 0%, #4f79ff 100%);
      color: #fff;
      font-weight: 600;
      font-size: 18px;
      padding: 12px 14px;
      cursor: pointer;
    }
    .login-primary:disabled { opacity: .7; cursor: not-allowed; }
    .login-meta { margin-top: 10px; color: #94a1bc; font-size: 13px; text-align: center; min-height: 18px; }
    .login-meta.error { color: #ff8f98; }
    .login-meta.success { color: #8fd8a7; }
    .login-switch { margin-top: 8px; text-align: center; font-size: 14px; color: #9ea8be; }
    .login-switch button { border: 0; background: transparent; color: #6f95ff; cursor: pointer; font-size: 14px; }
    .login-divider { display: flex; align-items: center; gap: 10px; margin: 14px 0 8px; color: #7f8aaa; font-size: 12px; }
    .login-divider::before, .login-divider::after { content: ""; flex: 1; height: 1px; background: #2b3040; }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(1px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 20;
    }

    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar {
      width: var(--sidebar-w);
      height: 100%;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width .2s ease, transform .2s ease;
      z-index: 30;
      flex: 0 0 auto;
      overflow: hidden;
    }

    .sidebar.closed {
      width: 0;
      border-right: 0;
    }

    .side-top { padding: 12px; display: flex; gap: 8px; }

    .icon-btn, .new-chat-btn, .chat-item, .bottom-btn {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 12px;
      transition: all .2s ease;
    }

    .icon-btn:hover, .new-chat-btn:hover, .bottom-btn:hover { background: var(--hover); }

    .new-chat-btn {
      height: 40px;
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .icon-btn {
      width: 46px;
      height: 46px;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .side-collapse {
      background: transparent;
      border: 0;
      border-radius: 10px;
      box-shadow: none;
      padding: 0;
    }

    .side-collapse:hover {
      background: color-mix(in srgb, var(--hover) 72%, transparent);
      transform: none;
    }

    .toggle-logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
      display: block;
    }
    .search-wrap { padding: 0 12px 10px; }

    .search {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }

    .search::placeholder { color: var(--muted); }

    .history {
      flex: 1;
      overflow: auto;
      padding: 0 8px 10px;
    }

    .chat-item {
      border: 0;
      width: 100%;
      text-align: left;
      padding: 10px 10px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      cursor: pointer;
      position: relative;
      color: var(--muted);
    }
    .chat-item-actions {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      opacity: 0;
      transition: opacity .2s ease;
    }
    .chat-item:hover .chat-item-actions { opacity: 1; }
    .pin-chat, .delete-chat {
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      padding: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pin-chat.pinned { color: var(--accent); }

    .chat-item:hover, .chat-item.active {
      background: var(--hover);
      color: var(--text);
    }

    .chat-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      font-size: 14px;
    }

    .delete-chat {
      border: 0;
      background: transparent;
      color: var(--muted);
      opacity: 0;
      cursor: pointer;
      transition: opacity .2s ease, color .2s ease;
    }

    .delete-chat:hover { color: var(--text); }

    .side-bottom {
      padding: 10px 12px 12px;
      border-top: 1px solid var(--border);
      position: relative;
    }

    .bottom-btn {
      width: 100%;
      border: 0;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      color: var(--muted);
      cursor: pointer;
    }

    .profile-dot {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #3a3a3a;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg);
      position: relative;
    }

    .header {
      height: var(--header-h);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      flex: 0 0 auto;
      background: var(--bg);
      z-index: 5;
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .auth-box { display: flex; align-items: center; gap: 8px; }
    .auth-trigger {
      width: 100%;
      border: 1px solid var(--border);
      background: var(--panel-2);
      border-radius: 16px;
      padding: 8px 10px;
      display: none;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease;
    }
    .auth-trigger:hover { background: var(--hover); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .auth-trigger.active {
      background: color-mix(in srgb, var(--hover) 72%, var(--panel-2));
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    .auth-user { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .auth-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border);
      display: none;
      background: var(--panel-2);
    }
    .auth-name {
      font-size: 13px;
      color: var(--text);
      max-width: 190px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      display: block;
    }
    .auth-more {
      border: 0;
      background: transparent;
      color: var(--muted);
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      padding: 0 2px;
    }
    .logout-btn { border: 1px solid var(--border); background: var(--panel-2); color: var(--text); border-radius: 9px; padding: 6px 10px; cursor: pointer; font-size: 12px; }
    .google-wrap { display: flex; justify-content: center; align-items: center; }
    .google-anchor { min-width: 46px; min-height: 46px; }
    .auth-required { width: 100%; max-width: var(--content-w); margin: 18px auto 0; padding: 0 16px; color: var(--muted); font-size: 14px; }
    .side-bottom .auth-box { margin-top: 8px; flex-wrap: nowrap; align-items: center; width: 100%; }
    .user-menu {
      position: absolute;
      left: 12px;
      bottom: 68px;
      min-width: 170px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      padding: 6px;
      z-index: 40;
      display: none;
    }
    .user-menu.open { display: block; }
    .menu-item {
      width: 100%;
      border: 0;
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .menu-item:hover { background: var(--hover); }
    .settings-modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 70;
      background: rgba(0,0,0,.55);
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .settings-modal.open { display: flex; }
    .settings-card {
      width: min(600px, 96vw);
      height: min(400px, 82vh);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--panel);
      display: grid;
      grid-template-columns: 180px 1fr;
      overflow: hidden;
    }
    .settings-nav { border-right: 1px solid var(--border); padding: 10px; background: var(--panel-2); }
    .settings-tab {
      width: 100%;
      border: 0;
      border-radius: 10px;
      background: transparent;
      color: var(--muted);
      text-align: left;
      padding: 10px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .settings-tab.active, .settings-tab:hover { background: var(--hover); color: var(--text); }
    .settings-content { padding: 16px; overflow: auto; }
    .settings-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .settings-title { margin: 0; font-size: 1.05rem; }
    .settings-close { border: 0; background: transparent; color: var(--muted); cursor: pointer; font-size: 18px; }
    .settings-pane { display: none; color: var(--muted); font-size: 14px; line-height: 1.6; }
    .settings-pane.active { display: block; }
    .theme-group { display: grid; gap: 10px; }
    .theme-title { margin: 0 0 4px; color: var(--text); font-size: 15px; font-weight: 600; }
    .theme-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    .theme-option {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--text);
      padding: 10px 8px;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
    }
    .theme-option.active {
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
      background: color-mix(in srgb, var(--accent) 18%, var(--panel-2));
    }
    .theme-note { font-size: 12px; color: var(--muted); }
    .profile-list { display: grid; }
    .profile-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .profile-left { color: var(--text); font-size: 16px; }
    .profile-right { color: var(--text); font-size: 16px; }
    .profile-right.muted { color: var(--muted); }
    .profile-btn {
      border-radius: 999px;
      padding: 9px 20px;
      border: 1px solid #a2414d;
      background: transparent;
      color: #ff6f7e;
      cursor: pointer;
      font-size: 16px;
      min-width: 112px;
      text-align: center;
    }
    .profile-btn:hover { background: rgba(162,65,77,.15); }
    .data-actions { display: grid; gap: 10px; }
    .data-btn {
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .data-btn:hover { background: var(--hover); }
    .data-btn.danger { border-color: #71323b; color: #ffb0bb; background: rgba(129,38,53,.18); }
    .data-btn.danger:hover { background: rgba(129,38,53,.3); }
    .data-note { font-size: 12px; color: var(--muted); }
    .about-list { display: grid; }
    .about-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .about-label { font-size: 16px; color: var(--text); }
    .about-view {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .about-view:hover { background: var(--hover); }

    .mobile-toggle {
      display: none;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .mobile-toggle:hover { background: var(--hover); color: var(--text); }

    .desktop-closed-toggle { display: none; }

    .sidebar.closed + .main .desktop-closed-toggle {
      display: grid;
      place-items: center;
    }

    .model-select {
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      color: var(--text);
      padding: 0 34px 0 10px;
      font-size: 13px;
      outline: none;
    }

    .chat-title {
      display: none;
    }

    .header-action {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .header-action:hover { background: var(--hover); color: var(--text); }

    .messages-wrap {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0 var(--input-h-gap);
      scrollbar-width: thin;
      scrollbar-color: #434343 transparent;
    }

    .welcome-panel {
      width: 100%;
      max-width: var(--content-w);
      margin: 120px auto 26px;
      padding: 0 16px;
      text-align: center;
    }

    .welcome-panel.hidden { display: none; }

    .welcome-mark {
      width: min(480px, 78vw);
      height: auto;
      margin: 0 auto;
      display: block;
      object-fit: contain;
    }

    .message-row {
      display: flex;
      width: 100%;
      max-width: var(--content-w);
      margin: 0 auto 24px;
      padding: 0 16px;
      animation: fadeUp .2s ease;
    }

    .message-row.user { justify-content: flex-end; }
    .message-row.assistant { justify-content: flex-start; }
    .message-row.search-hit .message {
      outline: 1px solid color-mix(in srgb, var(--accent) 65%, transparent);
      border-radius: 10px;
    }

    .message {
      max-width: 85%;
      font-size: 15px;
      line-height: 1.65;
      position: relative;
    }

    .message.user {
      background: var(--user-bubble);
      border-radius: 22px;
      padding: 11px 14px;
      max-width: 100%;
      width: fit-content;
    }
    .message.user .user-text {
      white-space: pre-wrap;
      word-break: normal;
      overflow-wrap: break-word;
    }

    .message.assistant { width: 100%; }

    .message.assistant p { margin: 0 0 10px; }
    .message.assistant ul, .message.assistant ol { margin: 0 0 10px; padding-left: 22px; }
    .message.assistant li { margin: 2px 0; }
    .message.assistant h1, .message.assistant h2, .message.assistant h3 {
      margin: 14px 0 8px;
      line-height: 1.3;
    }

    .message.assistant h1 { font-size: 1.22rem; }
    .message.assistant h2 { font-size: 1.12rem; }
    .message.assistant h3 { font-size: 1.02rem; }

    .message.assistant :not(pre) > code {
      background: var(--inline-code-bg);
      border: 1px solid var(--inline-code-border);
      border-radius: 6px;
      padding: 2px 6px;
      font-family: Consolas, "Courier New", monospace;
      font-size: .92em;
    }

    .code-wrap { position: relative; margin: 10px 0 6px; }

    .message.assistant pre {
      margin: 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--code-bg);
      padding: 14px;
      overflow-x: auto;
    }

    .message.assistant pre code {
      font-family: Consolas, "Courier New", monospace;
      font-size: .9em;
      line-height: 1.6;
      color: var(--code-text);
    }
    .msg-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .msg-action-btn {
      width: 30px;
      height: 30px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all .15s ease;
    }
    .msg-action-btn:hover {
      color: var(--text);
      background: color-mix(in srgb, var(--panel-2) 78%, transparent);
      border-color: var(--border);
    }
    .msg-action-btn.active {
      color: var(--accent);
      border-color: color-mix(in srgb, var(--accent) 45%, var(--border));
      background: color-mix(in srgb, var(--accent) 12%, transparent);
    }
    .user-msg-group {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      max-width: 85%;
    }
    .msg-actions.user-actions {
      margin-top: 0;
      gap: 4px;
    }
    .message.user .msg-action-btn {
      width: 28px;
      height: 28px;
      border-radius: 7px;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel);
      color: var(--muted);
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity .2s ease, color .2s ease;
    }

    .code-wrap:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { color: var(--text); }

    .typing {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--panel-2);
    }

    .typing span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--muted);
      animation: dot 1.1s infinite ease-in-out;
    }

    .typing span:nth-child(2) { animation-delay: .12s; }
    .typing span:nth-child(3) { animation-delay: .24s; }
    .tool-btn {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .tool-btn:hover { background: var(--hover); }
    .msg-search-input {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
      width: 180px;
      outline: none;
    }

    .input-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid var(--border);
      background: var(--input-bar-bg);
      backdrop-filter: blur(5px);
      padding: 10px 16px 16px;
      box-shadow: 0 -10px 24px rgba(0,0,0,.22);
    }

    .input-inner {
      width: 100%;
      max-width: var(--content-w);
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      border-radius: 24px;
      padding: 10px 12px;
      transition: border-color .2s ease;
    }

    .input-inner:focus-within { border-color: #4e73a6; }

    #q {
      flex: 1;
      resize: none;
      min-height: 24px;
      max-height: 200px;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font: inherit;
      line-height: 1.5;
    }

    #q::placeholder { color: var(--muted); }

    #sendBtn {
      width: 36px;
      height: 36px;
      border: 0;
      border-radius: 50%;
      background: var(--text);
      color: var(--send-fg);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all .2s ease;
      flex: 0 0 auto;
    }

    #sendBtn:hover { box-shadow: 0 0 16px rgba(255,255,255,.2); }
    #sendBtn.is-stop {
      background: #df3e3e;
      color: #fff;
    }

    .hidden-when-collapsed { display: inline; }
    .sidebar.closed .hidden-when-collapsed { display: none; }

    @keyframes dot {
      0%, 80%, 100% { transform: translateY(0); opacity: .45; }
      40% { transform: translateY(-4px); opacity: 1; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        width: var(--sidebar-w) !important;
      }

      .sidebar.closed {
        width: var(--sidebar-w) !important;
        border-right: 1px solid var(--border);
      }

      .sidebar.open { transform: translateX(0); }
      .mobile-toggle { display: grid; place-items: center; }
      .desktop-closed-toggle { display: none !important; }
      .side-collapse { display: none; }
      .message { max-width: 92%; }
      .input-bar { padding-left: 12px; padding-right: 12px; }
      .welcome-panel {
        margin-top: 92px;
      }
      .login-card { padding: 20px 16px; border-radius: 16px; }
      .logo-full { width: min(220px, 72vw); }
      .settings-card { width: min(96vw, 600px); height: min(82vh, 460px); grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .settings-nav { border-right: 0; border-bottom: 1px solid var(--border); display: flex; gap: 6px; overflow-x: auto; }
      .settings-tab { margin-bottom: 0; white-space: nowrap; }
      .chat-title {
      display: none;
    }
    }
  </style>
</head>
<body>
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="ashoBlueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#00f0ff"/>
        <stop offset="100%" stop-color="#0066ff"/>
      </linearGradient>
      <filter id="ashoGlow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="4" result="blur"/>
        <feMerge>
          <feMergeNode in="blur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
      <symbol id="ashoLogoFull" viewBox="0 0 1200 400">
        <polygon points="300,80 420,150 420,290 300,360 180,290 180,150" fill="none" stroke="url(#ashoBlueGradient)" stroke-width="10" filter="url(#ashoGlow)"/>
        <path d="M300 120 L360 300 L330 300 L312 250 L288 250 L270 300 L240 300 Z M294 220 L306 220 L300 195 Z" fill="url(#ashoBlueGradient)" filter="url(#ashoGlow)"/>
        <text x="500" y="240" font-size="120" font-family="Orbitron, Arial, sans-serif" font-weight="700">
          <tspan fill="#FFFFFF">Asho</tspan>
          <tspan fill="url(#ashoBlueGradient)" filter="url(#ashoGlow)">AI</tspan>
        </text>
      </symbol>
      <symbol id="ashoLogoIcon" viewBox="140 70 320 320">
        <polygon points="300,80 420,150 420,290 300,360 180,290 180,150" fill="none" stroke="url(#ashoBlueGradient)" stroke-width="10" filter="url(#ashoGlow)"/>
        <path d="M300 120 L360 300 L330 300 L312 250 L288 250 L270 300 L240 300 Z M294 220 L306 220 L300 195 Z" fill="url(#ashoBlueGradient)" filter="url(#ashoGlow)"/>
      </symbol>
    </defs>
  </svg>
  <div id="overlay" class="overlay"></div>
  <div class="layout">
    <div id="loginGate" class="login-gate">
      <div class="login-card">
        <div class="login-brand">
          <svg class="logo-full" viewBox="0 0 1200 400" aria-label="Asho AI logo" role="img"><use href="#ashoLogoFull"/></svg>
        </div>
        <h2 id="loginTitle" class="login-title">Sign in</h2>
        <p class="login-sub">Use your account to continue to Asho AI chat.</p>
        <form id="authForm" class="login-form">
          <input id="authNameInput" class="login-input" type="text" placeholder="Full name (for sign up)" style="display:none;" />
          <input id="authEmailInput" class="login-input" type="email" placeholder="Email address" autocomplete="email" />
          <div class="password-wrap">
            <input id="authPasswordInput" class="login-input" type="password" placeholder="Password" autocomplete="current-password" />
            <button id="passToggleBtn" class="pass-toggle" type="button" aria-label="Show password">Show</button>
          </div>
          <button id="authSubmitBtn" class="login-primary" type="submit">Sign in</button>
        </form>
        <div id="authMessage" class="login-meta"></div>
        <div class="login-switch">
          <span id="authSwitchText">New here?</span>
          <button id="authSwitchBtn" type="button">Create account</button>
        </div>
        <div class="login-divider">OR</div>
        <div class="google-wrap">
          <div id="googleSignIn" class="google-anchor" {% if not google_client_id %}style="display:none;"{% endif %}></div>
        </div>
      </div>
    </div>
    <aside id="sidebar" class="sidebar closed">
      <div class="side-top">
        <button id="newChat" class="new-chat-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14" stroke-linecap="round"/></svg>
          <span class="hidden-when-collapsed">New chat</span>
        </button>
        <button id="collapseBtn" class="icon-btn side-collapse" type="button" aria-label="Toggle sidebar">
          <svg class="logo-icon" viewBox="0 0 600 600" aria-label="Asho AI icon" role="img"><use href="#ashoLogoIcon"/></svg>
        </button>
      </div>

      <div class="search-wrap hidden-when-collapsed">
        <input id="search" class="search" placeholder="Search chats" />
      </div>

      <div class="history" id="history"></div>

      <div class="side-bottom">
        <div id="authBox" class="auth-box hidden-when-collapsed">
          <div id="authTrigger" class="auth-trigger">
            <div class="auth-user">
              <img id="authAvatar" class="auth-avatar" alt="User avatar" />
              <span id="authName" class="auth-name"></span>
            </div>
            <button id="authMoreBtn" class="auth-more" type="button" aria-label="Open menu">...</button>
          </div>
        </div>
        <div id="userMenu" class="user-menu">
          <button id="menuSettings" class="menu-item" type="button">Settings</button>
          <button id="menuHelp" class="menu-item" type="button">Help</button>
          <button id="menuLogout" class="menu-item" type="button">Logout</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="header">
        <div class="header-left">
          <button id="desktopClosedToggle" class="icon-btn side-collapse desktop-closed-toggle" type="button" aria-label="Open sidebar">
            <svg class="logo-icon" viewBox="0 0 600 600" aria-label="Asho AI icon" role="img"><use href="#ashoLogoIcon"/></svg>
          </button>
          <button id="mobileToggle" class="mobile-toggle" type="button" aria-label="Open sidebar">
            <svg class="logo-icon" viewBox="0 0 600 600" aria-label="Asho AI icon" role="img"><use href="#ashoLogoIcon"/></svg>
          </button>
          
        </div>

        <div class="chat-title" id="chatTitle">Asho AI</div>

        <div class="header-right"></div>
      </header>

      <section id="chat" class="messages-wrap">
        <div id="welcomePanel" class="welcome-panel">
          <svg class="welcome-mark" viewBox="0 0 1200 400" aria-label="Asho AI logo" role="img"><use href="#ashoLogoFull"/></svg>
        </div>
        <div id="authRequired" class="auth-required" style="display:none;">Please sign in to start chatting.</div>
      </section>

      <div class="input-bar">
        <form id="f" class="input-inner">
          <textarea id="q" rows="1" placeholder="Ask anything"></textarea>
          <button type="submit" id="sendBtn" aria-label="Send">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h13" stroke-linecap="round" />
              <path d="m12 5 7 7-7 7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </form>
      </div>
    </main>
  </div>
  <div id="settingsModal" class="settings-modal">
    <div class="settings-card">
      <div class="settings-nav">
        <button class="settings-tab active" data-tab="general" type="button">General</button>
        <button class="settings-tab" data-tab="profile" type="button">Profile</button>
        <button class="settings-tab" data-tab="data" type="button">Data</button>
        <button class="settings-tab" data-tab="about" type="button">About</button>
      </div>
      <div class="settings-content">
        <div class="settings-head">
          <h3 class="settings-title">Settings</h3>
          <button id="settingsClose" class="settings-close" type="button" aria-label="Close settings">x</button>
        </div>
        <div id="paneGeneral" class="settings-pane active">
          <div class="theme-group">
            <p class="theme-title">Theme</p>
            <div class="theme-grid">
              <button id="themeModeDark" class="theme-option" data-mode="dark" type="button">Dark</button>
              <button id="themeModeLight" class="theme-option" data-mode="light" type="button">Light</button>
              <button id="themeModeSystem" class="theme-option" data-mode="system" type="button">System</button>
            </div>
            <div class="theme-note">System uses your device appearance automatically.</div>
          </div>
        </div>
        <div id="paneProfile" class="settings-pane">
          <div class="profile-list">
            <div class="profile-row">
              <span class="profile-left">Name</span>
              <span id="profileName" class="profile-right">user name</span>
            </div>
            <div class="profile-row">
              <span class="profile-left">Email address</span>
              <span id="profileEmail" class="profile-right">ash******097@gmail.com</span>
            </div>
            <div class="profile-row">
              <span class="profile-left">Phone number</span>
              <span class="profile-right muted">-</span>
            </div>
            <div class="profile-row">
              <span class="profile-left">Log out of all devices</span>
              <button id="logoutBtn" class="profile-btn" type="button">Log out</button>
            </div>
            <div class="profile-row" style="border-bottom:0;">
              <span class="profile-left">Delete account</span>
              <button id="deleteAccountBtn" class="profile-btn" type="button">Delete</button>
            </div>
          </div>
        </div>
        <div id="paneData" class="settings-pane">
          <div class="data-actions">
            <button id="exportDataBtn" class="data-btn" type="button">Export conversations (JSON)</button>
            <button id="deleteAllDataBtn" class="data-btn danger" type="button">Delete all conversations</button>
            <div id="dataStatus" class="data-note"></div>
          </div>
        </div>
        <div id="paneAbout" class="settings-pane">
          <div class="about-list">
            <div class="about-row">
              <span class="about-label">Terms of Use</span>
              <button id="viewTermsBtn" class="about-view" type="button">View</button>
            </div>
            <div class="about-row" style="border-bottom:0;">
              <span class="about-label">Privacy Policy</span>
              <button id="viewPrivacyBtn" class="about-view" type="button">View</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const layout = document.querySelector(".layout");
    const loginGate = document.getElementById("loginGate");
    const collapseBtn = document.getElementById("collapseBtn");
    const desktopClosedToggle = document.getElementById("desktopClosedToggle");
    const mobileToggle = document.getElementById("mobileToggle");
    const searchInput = document.getElementById("search");
    const historyEl = document.getElementById("history");
    const chatTitle = document.getElementById("chatTitle");
    const newChatBtn = document.getElementById("newChat");
    const authName = document.getElementById("authName");
    const authTrigger = document.getElementById("authTrigger");
    const authMoreBtn = document.getElementById("authMoreBtn");
    const authAvatar = document.getElementById("authAvatar");
    const userMenu = document.getElementById("userMenu");
    const menuSettings = document.getElementById("menuSettings");
    const menuHelp = document.getElementById("menuHelp");
    const menuLogout = document.getElementById("menuLogout");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const deleteAccountBtn = document.getElementById("deleteAccountBtn");
    const exportDataBtn = document.getElementById("exportDataBtn");
    const deleteAllDataBtn = document.getElementById("deleteAllDataBtn");
    const dataStatus = document.getElementById("dataStatus");
    const settingsModal = document.getElementById("settingsModal");
    const settingsClose = document.getElementById("settingsClose");
    const settingsTabs = Array.from(document.querySelectorAll(".settings-tab"));
    const themeModeButtons = Array.from(document.querySelectorAll(".theme-option"));
    const paneGeneral = document.getElementById("paneGeneral");
    const paneProfile = document.getElementById("paneProfile");
    const paneData = document.getElementById("paneData");
    const paneAbout = document.getElementById("paneAbout");
    const viewTermsBtn = document.getElementById("viewTermsBtn");
    const viewPrivacyBtn = document.getElementById("viewPrivacyBtn");
    const authForm = document.getElementById("authForm");
    const authNameInput = document.getElementById("authNameInput");
    const authEmailInput = document.getElementById("authEmailInput");
    const authPasswordInput = document.getElementById("authPasswordInput");
    const passToggleBtn = document.getElementById("passToggleBtn");
    const authSubmitBtn = document.getElementById("authSubmitBtn");
    const authMessage = document.getElementById("authMessage");
    const authSwitchBtn = document.getElementById("authSwitchBtn");
    const authSwitchText = document.getElementById("authSwitchText");
    const loginTitle = document.getElementById("loginTitle");
    const googleSignInEl = document.getElementById("googleSignIn");
    const authRequired = document.getElementById("authRequired");
    const messageSearchInput = document.getElementById("messageSearchInput");
    const editLastBtn = document.getElementById("editLastBtn");
    const regenBtn = document.getElementById("regenBtn");

    const chat = document.getElementById("chat");
    const welcomePanel = document.getElementById("welcomePanel");
    const form = document.getElementById("f");
    const input = document.getElementById("q");
    const sendBtn = document.getElementById("sendBtn");
    const sendIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h13" stroke-linecap="round"></path><path d="m12 5 7 7-7 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>';
    const stopIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="7" y="7" width="10" height="10" rx="2"></rect></svg>';

    const controls = {
      messageSearchInput,
      editLastBtn,
      regenBtn,
    };

    let controller;
    let isStreaming = false;
    let chats = [];
    let activeChatId = null;
    let currentConversationMessages = [];
    let currentUser = null;
    let authMode = "signin";
    const AUTH_ENABLED = {{ 'true' if auth_enabled else 'false' }};
    const GOOGLE_CLIENT_ID = "{{ google_client_id }}";

    function isMobile() {
      return window.matchMedia("(max-width: 900px)").matches;
    }

    function setAuthMode(mode) {
      authMode = mode === "signup" ? "signup" : "signin";
      const signUp = authMode === "signup";
      loginTitle.textContent = signUp ? "Create account" : "Sign in";
      authNameInput.style.display = signUp ? "block" : "none";
      authPasswordInput.autocomplete = signUp ? "new-password" : "current-password";
      authSubmitBtn.textContent = signUp ? "Create account" : "Sign in";
      authSwitchText.textContent = signUp ? "Already have an account?" : "New here?";
      authSwitchBtn.textContent = signUp ? "Sign in" : "Create account";
      authMessage.textContent = "";
      authMessage.className = "login-meta";
    }

    function getThemeMode() {
      const mode = localStorage.getItem("theme_mode");
      return mode === "dark" || mode === "light" || mode === "system" ? mode : "system";
    }

    function applyThemeModeVisual(mode) {
      themeModeButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.mode === mode));
    }

    function toggleUserMenu(show) {
      const isOpen = show ?? !userMenu.classList.contains("open");
      userMenu.classList.toggle("open", isOpen);
      authTrigger.classList.toggle("active", isOpen);
    }

    function openSettings(tab = "general") {
      settingsModal.classList.add("open");
      setSettingsTab(tab);
      toggleUserMenu(false);
    }

    function closeSettings() {
      settingsModal.classList.remove("open");
    }

    function setSettingsTab(tab) {
      settingsTabs.forEach((btn) => btn.classList.toggle("active", btn.dataset.tab === tab));
      paneGeneral.classList.toggle("active", tab === "general");
      paneProfile.classList.toggle("active", tab === "profile");
      paneData.classList.toggle("active", tab === "data");
      paneAbout.classList.toggle("active", tab === "about");
    }

    function maskEmail(email) {
      const v = String(email || "").trim();
      const at = v.indexOf("@");
      if (at <= 2) return v || "Not available";
      const name = v.slice(0, at);
      const domain = v.slice(at);
      return `${name.slice(0, 3)}******${name.slice(-3)}${domain}`;
    }

    function setDataStatus(text, isError = false) {
      dataStatus.textContent = text || "";
      dataStatus.style.color = isError ? "#ff8f98" : "";
    }

    async function apiJson(url, options = {}) {
      const res = await fetch(url, options);
      let payload = {};
      try {
        payload = await res.json();
      } catch {}
      if (!res.ok) {
        if (res.status === 401) {
          updateAuthUI(null);
          if (AUTH_ENABLED) showAuthRequired(true);
        }
        throw new Error(payload.error || "Request failed.");
      }
      return payload;
    }

    function showAuthRequired(show) {
      authRequired.style.display = show ? "block" : "none";
      layout.classList.toggle("auth-locked", show);
      loginGate.style.display = show ? "grid" : "none";
      input.disabled = show;
      sendBtn.disabled = show;
      newChatBtn.disabled = show;
    }

    function updateAuthUI(user) {
      currentUser = user || null;
      if (!AUTH_ENABLED) {
        googleSignInEl.style.display = "none";
        authTrigger.style.display = "none";
        authAvatar.style.display = "none";
        authAvatar.removeAttribute("src");
        showAuthRequired(false);
        return;
      }
      if (currentUser) {
        authName.textContent = currentUser.name || currentUser.email || "Signed in";
        profileName.textContent = currentUser.name || "user name";
        profileEmail.textContent = maskEmail(currentUser.email || "");
        authTrigger.style.display = "flex";
        if (currentUser.picture) {
          authAvatar.src = currentUser.picture;
          authAvatar.style.display = "block";
        } else {
          authAvatar.style.display = "none";
          authAvatar.removeAttribute("src");
        }
        googleSignInEl.style.display = "none";
        showAuthRequired(false);
      } else {
        profileName.textContent = "user name";
        profileEmail.textContent = "Not available";
        authTrigger.style.display = "none";
        authAvatar.style.display = "none";
        authAvatar.removeAttribute("src");
        googleSignInEl.style.display = "block";
        showAuthRequired(true);
      }
    }

    async function loadAuthState() {
      const res = await fetch("/auth/me");
      if (!res.ok) return;
      const payload = await res.json();
      updateAuthUI(payload.user || null);
    }

    async function handleGoogleCredential(credential) {
      const res = await fetch("/auth/google", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ credential }),
      });
      if (!res.ok) {
        updateAuthUI(null);
        return;
      }
      const payload = await res.json();
      updateAuthUI(payload.user || null);
      await loadConversations(null, { autoSelectExisting: false }).catch(() => {});
    }

    async function submitAuthForm(e) {
      e.preventDefault();
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value;
      const name = authNameInput.value.trim();
      if (!email || !password) {
        authMessage.textContent = "Email and password are required.";
        return;
      }
      const url = authMode === "signup" ? "/auth/register" : "/auth/login";
      const body = authMode === "signup" ? { email, password, name } : { email, password };
      authSubmitBtn.disabled = true;
      authSubmitBtn.textContent = authMode === "signup" ? "Creating..." : "Signing in...";
      authMessage.textContent = "Please wait...";
      authMessage.className = "login-meta";
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          authMessage.textContent = payload.error || "Authentication failed.";
          authMessage.className = "login-meta error";
          return;
        }
        updateAuthUI(payload.user || null);
        authMessage.textContent = "Success. Redirecting...";
        authMessage.className = "login-meta success";
        authEmailInput.value = "";
        authPasswordInput.value = "";
        authNameInput.value = "";
        await loadConversations(null, { autoSelectExisting: false }).catch(() => {});
      } finally {
        authSubmitBtn.disabled = false;
        authSubmitBtn.textContent = authMode === "signup" ? "Create account" : "Sign in";
      }
    }

    function initGoogleSignIn() {
      if (!AUTH_ENABLED) return;
      if (!window.google || !GOOGLE_CLIENT_ID) return;
      window.google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => handleGoogleCredential(resp.credential),
      });
      window.google.accounts.id.renderButton(googleSignInEl, {
        type: "icon",
        theme: "outline",
        shape: "circle",
        size: "large",
        text: "signin_with",
      });
    }

    function updateChatMeta(id, title) {
      const idx = chats.findIndex(c => c.id === id);
      if (idx === -1) return;
      chats[idx].title = title || chats[idx].title;
      const updated = chats.splice(idx, 1)[0];
      chats.unshift(updated);
    }

    function renderHistory() {
      const q = (searchInput.value || "").toLowerCase();
      const ordered = [...chats].sort((a, b) => {
        const pa = Number(a.pinned || 0);
        const pb = Number(b.pinned || 0);
        if (pb !== pa) return pb - pa;
        return String(b.updated_at || "").localeCompare(String(a.updated_at || ""));
      });
      const filtered = ordered.filter(c => (c.title || "").toLowerCase().includes(q));
      historyEl.innerHTML = "";

      for (const c of filtered) {
        const row = document.createElement("button");
        row.type = "button";
        row.className = "chat-item" + (c.id === activeChatId ? " active" : "");
        row.innerHTML = `
          <span class="chat-label">${escapeHtml(c.title || "New chat")}</span>
          <span class="chat-item-actions">
            <span class="pin-chat ${c.pinned ? "pinned" : ""}" aria-label="Pin">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="${c.pinned ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2"><path d="M12 17v5" stroke-linecap="round"/><path d="M5 3h14l-3 8v3H8v-3L5 3z" stroke-linejoin="round"/></svg>
            </span>
            <span class="delete-chat" aria-label="Delete">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18" stroke-linecap="round"/><path d="M8 6V4h8v2" stroke-linecap="round"/><path d="m19 6-1 14H6L5 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
          </span>
        `;

        row.addEventListener("click", async (e) => {
          const del = e.target.closest(".delete-chat");
          const pin = e.target.closest(".pin-chat");
          if (pin) {
            e.stopPropagation();
            await apiJson(`/conversations/${c.id}/pin`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ pinned: !c.pinned }),
            });
            c.pinned = c.pinned ? 0 : 1;
            c.updated_at = new Date().toISOString();
            renderHistory();
            return;
          }
          if (del) {
            e.stopPropagation();
            await deleteConversation(c.id);
            return;
          }
          await selectConversation(c.id);
          if (isMobile()) closeMobileSidebar();
        });

        historyEl.appendChild(row);
      }
    }

    function setDesktopSidebarClosed(closed) {
      sidebar.classList.toggle("closed", closed);
      collapseBtn.setAttribute("aria-label", closed ? "Open sidebar" : "Close sidebar");
    }

    function toggleDesktopSidebar() {
      setDesktopSidebarClosed(!sidebar.classList.contains("closed"));
    }

    function openMobileSidebar() {
      sidebar.classList.add("open");
      overlay.classList.add("open");
    }

    function closeMobileSidebar() {
      sidebar.classList.remove("open");
      overlay.classList.remove("open");
    }

    function autoResize() {
      input.style.height = "0px";
      input.style.height = Math.min(input.scrollHeight, 200) + "px";
    }

    function scrollToBottom() {}

    function clearMessages() {
      chat.querySelectorAll(".message-row").forEach((row) => row.remove());
      removeTyping();
    }

    function setWelcomeVisible(isVisible) {
      welcomePanel.classList.toggle("hidden", !isVisible);
    }

    function refreshWelcome() {
      const hasMessage = !!chat.querySelector(".message-row");
      setWelcomeVisible(!hasMessage);
    }

    function addMessageRow(kind, htmlText) {
      setWelcomeVisible(false);
      const row = document.createElement("div");
      row.className = "message-row " + kind;
      const msg = document.createElement("article");
      msg.className = "message " + kind;
      if (kind === "assistant") {
        msg.innerHTML = htmlText;
      } else {
        msg.innerHTML = `<span class="user-text">${escapeHtml(htmlText || "")}</span>`;
      }
      row.appendChild(msg);
      chat.appendChild(row);
      return msg;
    }

    function renderConversationMessages(messages) {
      currentConversationMessages = (messages || []).map((m) => ({ role: m.role, content: m.content || "" }));
      clearMessages();
      for (const m of messages || []) {
        if (m.role === "assistant") {
          const node = addMessageRow("assistant", renderSafeMarkdown(m.content || ""));
          addCopyButtons(node);
          ensureMessageActions(node);
        } else if (m.role === "user") {
          const node = addMessageRow("user", m.content || "");
          ensureUserMessageActions(node);
        }
      }
      applyMessageSearch();
      refreshWelcome();
    }

    function applyMessageSearch() {
      const q = ((controls.messageSearchInput && controls.messageSearchInput.value) || "")
        .trim()
        .toLowerCase();
      const rows = Array.from(chat.querySelectorAll(".message-row"));
      rows.forEach((row) => row.classList.remove("search-hit"));
      if (!q) return;
      rows.forEach((row) => {
        const msg = row.querySelector(".message");
        if (!msg) return;
        const text = (msg.textContent || "").toLowerCase();
        if (text.includes(q)) row.classList.add("search-hit");
      });
    }

    function findLastUserMessageIndex() {
      for (let i = currentConversationMessages.length - 1; i >= 0; i -= 1) {
        if (currentConversationMessages[i].role === "user") return i;
      }
      return -1;
    }

    async function regenerateLastMessage(editedText = null) {
      if (!activeChatId) return;
      const lastUserIdx = findLastUserMessageIndex();
      if (lastUserIdx === -1) return;

      if (editedText !== null) {
        currentConversationMessages[lastUserIdx].content = editedText;
      }
      currentConversationMessages = currentConversationMessages.slice(0, lastUserIdx + 1);
      renderConversationMessages(currentConversationMessages);
      addTyping();

      controller = new AbortController();
      try {
        const body = {};
        if (editedText !== null) body.message = editedText;
        const res = await fetch(`/conversations/${activeChatId}/regenerate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          signal: controller.signal,
        });
        if (!res.ok || !res.body) {
          removeTyping();
          addMessageRow("assistant", "Request failed.");
          return;
        }
        const titleFromHeader = res.headers.get("X-Conversation-Title");
        if (titleFromHeader) {
          chatTitle.textContent = titleFromHeader;
          updateChatMeta(activeChatId, titleFromHeader);
        }
        removeTyping();
        const botDiv = addMessageRow("assistant", "");
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let botText = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          botText += decoder.decode(value, { stream: true });
          botDiv.innerHTML = renderSafeMarkdown(botText);
          addCopyButtons(botDiv);
        }
        ensureMessageActions(botDiv);
        await loadConversations(activeChatId);
      } catch (err) {
        removeTyping();
        if (err.name === "AbortError") {
          addMessageRow("assistant", "Stopped.");
        } else {
          addMessageRow("assistant", "Request failed.");
        }
      } finally {
        controller = undefined;
        setStreaming(false);
      }
    }

    function addTyping() {
      setWelcomeVisible(false);
      const row = document.createElement("div");
      row.className = "message-row assistant";
      row.id = "typingRow";
      row.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
      chat.appendChild(row);
    }

    function removeTyping() {
      const t = document.getElementById("typingRow");
      if (t) t.remove();
    }

    function addCopyButtons(container) {
      const blocks = container.querySelectorAll("pre > code");
      for (const code of blocks) {
        const pre = code.parentElement;
        if (!pre || pre.parentElement?.classList.contains("code-wrap")) continue;

        const wrap = document.createElement("div");
        wrap.className = "code-wrap";
        pre.parentNode.insertBefore(wrap, pre);
        wrap.appendChild(pre);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "copy-btn";
        btn.textContent = "Copy";
        btn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(code.textContent || "");
            btn.textContent = "Copied";
            setTimeout(() => btn.textContent = "Copy", 1200);
          } catch {
            btn.textContent = "Failed";
            setTimeout(() => btn.textContent = "Copy", 1200);
          }
        });
        wrap.appendChild(btn);
      }
    }

    function ensureMessageActions(container) {
      if (!container || container.querySelector(".msg-actions")) return;
      const bar = document.createElement("div");
      bar.className = "msg-actions";
      bar.innerHTML = `
        <button type="button" class="msg-action-btn act-copy" title="Copy">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="11" height="11" rx="2"></rect><rect x="4" y="4" width="11" height="11" rx="2"></rect></svg>
        </button>
        <button type="button" class="msg-action-btn act-regen" title="Regenerate">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-2.64-6.36" stroke-linecap="round"></path><path d="M21 3v6h-6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </button>
        <button type="button" class="msg-action-btn act-like" title="Like">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10v10" stroke-linecap="round"></path><path d="M11 10l3-6c.5-1 2-1 2.6 0 .3.5.4 1.1.2 1.7L16 10h3c1.1 0 2 .9 2 2l-1 7c-.2 1-1 1.7-2 1.7H9c-1.1 0-2-.9-2-2v-8c0-1.1.9-2 2-2h2z" stroke-linejoin="round"></path></svg>
        </button>
        <button type="button" class="msg-action-btn act-dislike" title="Dislike">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 14V4" stroke-linecap="round"></path><path d="M13 14l-3 6c-.5 1-2 1-2.6 0-.3-.5-.4-1.1-.2-1.7L8 14H5c-1.1 0-2-.9-2-2l1-7c.2-1 1-1.7 2-1.7h9c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2h-2z" stroke-linejoin="round"></path></svg>
        </button>
        <button type="button" class="msg-action-btn act-share" title="Share">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 8l5-5"></path><path d="M17 3h3v3"></path><path d="M4 12v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6"></path></svg>
        </button>
      `;
      container.appendChild(bar);

      const copyBtn = bar.querySelector(".act-copy");
      const regenActionBtn = bar.querySelector(".act-regen");
      const likeBtn = bar.querySelector(".act-like");
      const dislikeBtn = bar.querySelector(".act-dislike");
      const shareBtn = bar.querySelector(".act-share");

      copyBtn.addEventListener("click", async () => {
        const text = (container.textContent || "").trim();
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.classList.add("active");
          setTimeout(() => copyBtn.classList.remove("active"), 700);
        } catch {}
      });
      regenActionBtn.addEventListener("click", () => {
        if (isStreaming) return;
        regenerateLastMessage(null).catch(() => {});
      });
      likeBtn.addEventListener("click", () => {
        likeBtn.classList.toggle("active");
        if (likeBtn.classList.contains("active")) dislikeBtn.classList.remove("active");
      });
      dislikeBtn.addEventListener("click", () => {
        dislikeBtn.classList.toggle("active");
        if (dislikeBtn.classList.contains("active")) likeBtn.classList.remove("active");
      });
      shareBtn.addEventListener("click", async () => {
        const text = (container.textContent || "").trim();
        try {
          if (navigator.share) {
            await navigator.share({ text });
          } else {
            await navigator.clipboard.writeText(text);
            shareBtn.classList.add("active");
            setTimeout(() => shareBtn.classList.remove("active"), 700);
          }
        } catch {}
      });
    }

    function ensureUserMessageActions(container) {
      if (!container) return;
      const row = container.parentElement;
      if (!row) return;
      let group = row.querySelector(".user-msg-group");
      if (!group) {
        group = document.createElement("div");
        group.className = "user-msg-group";
        row.replaceChild(group, container);
        group.appendChild(container);
      }
      if (group.querySelector(".msg-actions")) return;

      const bar = document.createElement("div");
      bar.className = "msg-actions user-actions";
      bar.innerHTML = `
        <button type="button" class="msg-action-btn usr-copy" title="Copy">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="11" height="11" rx="2"></rect><rect x="4" y="4" width="11" height="11" rx="2"></rect></svg>
        </button>
        <button type="button" class="msg-action-btn usr-edit" title="Edit">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
        </button>
      `;
      group.appendChild(bar);

      const copyBtn = bar.querySelector(".usr-copy");
      const editBtn = bar.querySelector(".usr-edit");
      copyBtn.addEventListener("click", async () => {
        const text = (container.querySelector(".user-text")?.textContent || "").trim();
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.classList.add("active");
          setTimeout(() => copyBtn.classList.remove("active"), 700);
        } catch {}
      });
      editBtn.addEventListener("click", () => {
        const text = (container.querySelector(".user-text")?.textContent || "").trim();
        input.value = text;
        autoResize();
        input.focus();
        editBtn.classList.add("active");
        setTimeout(() => editBtn.classList.remove("active"), 700);
      });
    }

    function setStreaming(streaming) {
      isStreaming = streaming;
      input.disabled = streaming;
      sendBtn.classList.toggle("is-stop", streaming);
      sendBtn.setAttribute("aria-label", streaming ? "Stop" : "Send");
      sendBtn.innerHTML = streaming ? stopIcon : sendIcon;
    }

    function applyTheme(theme, persistTheme = true) {
      document.body.setAttribute("data-theme", theme);
      if (persistTheme) localStorage.setItem("theme", theme);
    }

    function applyThemeMode(mode) {
      const m = mode === "dark" || mode === "light" || mode === "system" ? mode : "system";
      localStorage.setItem("theme_mode", m);
      applyThemeModeVisual(m);
      if (m === "system") {
        const prefersLight = window.matchMedia("(prefers-color-scheme: light)").matches;
        applyTheme(prefersLight ? "light" : "dark", false);
      } else {
        applyTheme(m);
      }
    }

    function initTheme() {
      const mode = getThemeMode();
      applyThemeMode(mode);
    }

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderSafeMarkdown(text) {
      const rawHtml = marked.parse(text || "");
      return DOMPurify.sanitize(rawHtml);
    }

    async function selectConversation(conversationId) {
      const data = await apiJson(`/conversations/${conversationId}`);
      const c = data.conversation;
      activeChatId = c.id;
      chatTitle.textContent = c.title || "New chat";
      renderConversationMessages(c.messages || []);
      renderHistory();
    }

    async function deleteConversation(conversationId) {
      await apiJson(`/conversations/${conversationId}`, { method: "DELETE" });
      chats = chats.filter(c => c.id !== conversationId);
      if (activeChatId === conversationId) {
        if (chats.length) {
          await selectConversation(chats[0].id);
        } else {
          activeChatId = null;
          chatTitle.textContent = "Asho AI";
          clearMessages();
          refreshWelcome();
          renderHistory();
        }
      } else {
        renderHistory();
      }
    }

    async function loadConversations(preferredId = null, opts = {}) {
      const autoSelectExisting = opts.autoSelectExisting ?? true;
      const data = await apiJson("/conversations");
      chats = data.conversations || [];
      renderHistory();
      if (chats.length) {
        if (preferredId && chats.some(c => c.id === preferredId)) {
          await selectConversation(preferredId);
          return;
        }
        if (autoSelectExisting && activeChatId && chats.some(c => c.id === activeChatId)) {
          await selectConversation(activeChatId);
          return;
        }
        if (!autoSelectExisting) {
          activeChatId = null;
          chatTitle.textContent = "New chat";
          clearMessages();
          refreshWelcome();
          renderHistory();
        }
      } else {
        activeChatId = null;
        chatTitle.textContent = "Asho AI";
        clearMessages();
        refreshWelcome();
      }
    }

    collapseBtn.addEventListener("click", toggleDesktopSidebar);
    desktopClosedToggle.addEventListener("click", toggleDesktopSidebar);
    mobileToggle.addEventListener("click", () => {
      if (isMobile()) {
        openMobileSidebar();
      } else {
        toggleDesktopSidebar();
      }
    });
    overlay.addEventListener("click", closeMobileSidebar);
    searchInput.addEventListener("input", renderHistory);

    newChatBtn.addEventListener("click", () => {
      activeChatId = null;
      chatTitle.textContent = "New chat";
      clearMessages();
      refreshWelcome();
      renderHistory();
      if (isMobile()) closeMobileSidebar();
    });

    input.addEventListener("input", autoResize);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    themeModeButtons.forEach((btn) => {
      btn.addEventListener("click", () => applyThemeMode(btn.dataset.mode));
    });
    window.matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
      if (getThemeMode() === "system") applyThemeMode("system");
    });
    authSwitchBtn.addEventListener("click", () => {
      setAuthMode(authMode === "signin" ? "signup" : "signin");
    });
    authForm.addEventListener("submit", submitAuthForm);
    passToggleBtn.addEventListener("click", () => {
      const visible = authPasswordInput.type === "text";
      authPasswordInput.type = visible ? "password" : "text";
      passToggleBtn.textContent = visible ? "Show" : "Hide";
      passToggleBtn.setAttribute("aria-label", visible ? "Show password" : "Hide password");
    });
    authTrigger.addEventListener("click", (e) => {
      e.stopPropagation();
      if (!currentUser) return;
      toggleUserMenu();
    });
    authMoreBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (!currentUser) return;
      toggleUserMenu();
    });
    menuSettings.addEventListener("click", () => openSettings("general"));
    menuHelp.addEventListener("click", () => {
      toggleUserMenu(false);
      openSettings("about");
    });
    menuLogout.addEventListener("click", async () => {
      toggleUserMenu(false);
      await fetch("/auth/logout", { method: "POST" }).catch(() => {});
      updateAuthUI(null);
      activeChatId = null;
      clearMessages();
      refreshWelcome();
      renderHistory();
    });
    logoutBtn.addEventListener("click", async () => {
      await fetch("/auth/logout_all", { method: "POST" }).catch(() => {});
      closeSettings();
      updateAuthUI(null);
      activeChatId = null;
      clearMessages();
      refreshWelcome();
      renderHistory();
    });
    deleteAccountBtn.addEventListener("click", async () => {
      const ok = confirm("Delete account permanently? This will remove your profile and all chat data.");
      if (!ok) return;
      await fetch("/auth/delete", { method: "POST" }).catch(() => {});
      closeSettings();
      updateAuthUI(null);
      activeChatId = null;
      clearMessages();
      refreshWelcome();
      renderHistory();
    });
    exportDataBtn.addEventListener("click", async () => {
      setDataStatus("Preparing export...");
      try {
        const res = await fetch("/conversations/export");
        if (!res.ok) throw new Error("export failed");
        const payload = await res.json();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const stamp = new Date().toISOString().replace(/[:.]/g, "-");
        a.href = url;
        a.download = `asho-ai-conversations-${stamp}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setDataStatus("Export complete.");
      } catch {
        setDataStatus("Export failed.", true);
      }
    });
    deleteAllDataBtn.addEventListener("click", async () => {
      const ok = confirm("Delete all your conversations permanently?");
      if (!ok) return;
      setDataStatus("Deleting conversations...");
      try {
        const res = await fetch("/reset", { method: "POST" });
        if (!res.ok) throw new Error("delete failed");
        activeChatId = null;
        chats = [];
        clearMessages();
        refreshWelcome();
        renderHistory();
        setDataStatus("All conversations deleted.");
      } catch {
        setDataStatus("Delete failed.", true);
      }
    });
    viewTermsBtn.addEventListener("click", () => {
      window.open("/terms", "_blank");
    });
    viewPrivacyBtn.addEventListener("click", () => {
      window.open("/privacy", "_blank");
    });
    settingsClose.addEventListener("click", closeSettings);
    settingsModal.addEventListener("click", (e) => {
      if (e.target === settingsModal) closeSettings();
    });
    settingsTabs.forEach((btn) => {
      btn.addEventListener("click", () => setSettingsTab(btn.dataset.tab));
    });
    if (controls.messageSearchInput) {
      controls.messageSearchInput.addEventListener("input", applyMessageSearch);
    }
    if (controls.regenBtn) {
      controls.regenBtn.addEventListener("click", async () => {
        if (!activeChatId || isStreaming) return;
        if (findLastUserMessageIndex() === -1) return;
        setStreaming(true);
        await regenerateLastMessage(null);
        input.focus();
      });
    }
    if (controls.editLastBtn) {
      controls.editLastBtn.addEventListener("click", async () => {
        if (!activeChatId || isStreaming) return;
        const idx = findLastUserMessageIndex();
        if (idx === -1) return;
        const original = currentConversationMessages[idx].content || "";
        const edited = prompt("Edit your last message:", original);
        if (edited === null) return;
        const text = edited.trim();
        if (!text) return;
        setStreaming(true);
        await regenerateLastMessage(text);
        input.focus();
      });
    }
    document.addEventListener("click", () => toggleUserMenu(false));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (isStreaming) {
        if (controller) controller.abort();
        return;
      }

      const text = input.value.trim();
      if (!text) return;
      if (AUTH_ENABLED && !currentUser) return;

      setStreaming(true);
      input.value = "";
      autoResize();
      const userNode = addMessageRow("user", text);
      ensureUserMessageActions(userNode);

      removeTyping();
      addTyping();

      controller = new AbortController();

      try {
        const payload = { message: text };
        if (activeChatId) payload.conversation_id = activeChatId;

        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });

        if (!res.ok || !res.body) {
          removeTyping();
          addMessageRow("assistant", "Request failed.");
          return;
        }

        const responseConversationId = res.headers.get("X-Conversation-Id");
        if (responseConversationId) {
          activeChatId = responseConversationId;
        }

        const titleFromHeader = res.headers.get("X-Conversation-Title");
        if (titleFromHeader) {
          chatTitle.textContent = titleFromHeader;
          updateChatMeta(activeChatId, titleFromHeader);
          renderHistory();
        }
        removeTyping();
        const botDiv = addMessageRow("assistant", "");

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let botText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          botText += decoder.decode(value, { stream: true });
          botDiv.innerHTML = renderSafeMarkdown(botText);
          addCopyButtons(botDiv);
        }
        ensureMessageActions(botDiv);

        await loadConversations(activeChatId);
      } catch (err) {
        removeTyping();
        if (err.name === "AbortError") {
          addMessageRow("assistant", "Stopped.");
        } else {
          addMessageRow("assistant", "Request failed.");
        }
      } finally {
        controller = undefined;
        setStreaming(false);
        input.focus();
      }
    });

    window.addEventListener("resize", () => {
      if (isMobile()) {
        sidebar.classList.remove("closed");
      } else {
        closeMobileSidebar();
      }
    });

    if (isMobile()) {
      sidebar.classList.remove("closed");
    } else {
      setDesktopSidebarClosed(true);
    }

    initTheme();
    setAuthMode("signin");
    autoResize();
    loadAuthState().then(() => {
      if (AUTH_ENABLED && !currentUser) return;
      return loadConversations(null, { autoSelectExisting: false });
    }).catch(() => {
      chatTitle.textContent = "Asho AI";
      clearMessages();
      refreshWelcome();
    });
    setTimeout(initGoogleSignIn, 200);
  </script>
</body>
</html>
















